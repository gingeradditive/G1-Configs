[mcu dryer_board]
serial: /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0

[output_pin DRYER_MOTOR_PIN]
pin: dryer_board: PD2 #TODO: set correct pin

[output_pin DRYER_DIR_PIN]
pin: dryer_board: PD3 #TODO: set correct pin

[heater_generic DRYER_HEATER]
heater_pin: dryer_board: PD5 #TODO: set correct pin
sensor_pin: dryer_board: PC1 #TODO: set correct pin
sensor_type: EPCOS 100K B57560G104F
control: pid
pid_Kp: 90
pid_Ki: 1.110
pid_Kd: 1287.354
min_temp: 0
max_temp: 110
pwm_cycle_time: 0.100
max_power: 1

[gcode_macro DRYER_CONFIG]
variable_dryer_enabled: False
variable_saved_temp: 0
gcode: 
    DRYER_DRYNG_STEP_1

[gcode_macro TOGGLE_DRYER]
gcode:
    {% if printer["gcode_macro DRYER_CONFIG"].dryer_enabled %}
        SET_GCODE_VARIABLE MACRO=DRYER_CONFIG VARIABLE=dryer_enabled VALUE=False
        M118 Dryer disabilitato
    {% else %}
        SET_GCODE_VARIABLE MACRO=DRYER_CONFIG VARIABLE=dryer_enabled VALUE=True
        M118 Dryer abilitato
        DRYER_DRYNG_STEP_1
    {% endif %}


[gcode_macro DRYER_DRYNG_STEP_1]
gcode:
    {% if not printer["gcode_macro DRYER_CONFIG"].dryer_enabled %}
        M118 Dryer disabilitato, uscita da DRYER_DRYNG_STEP_1
        RETURN
    {% endif %}
    SET_PIN PIN=DRYER_MOTOR_PIN VALUE=0
    M118 DRYER: Motore spento, attendo 5s per DRYER_DRYNG_STEP_2
    UPDATE_DELAYED_GCODE  ID=call_drying_step2 DURATION=5

[gcode_macro DRYER_DRYNG_STEP_2]
gcode:
    {% if not printer["gcode_macro DRYER_CONFIG"].dryer_enabled %}
        M118 Dryer disabilitato, uscita da DRYER_DRYNG_STEP_2
        RETURN
    {% endif %}
    SET_PIN PIN=DRYER_DIR_PIN VALUE=0
    SET_PIN PIN=DRYER_MOTOR_PIN VALUE=1
    M118 DRYER: Modalità asciugatura attiva, attendo 10min per rigenerazione
    UPDATE_DELAYED_GCODE  ID=call_regen_step1 DURATION=600


[gcode_macro DRYER_REGENERATION_STEP_1]
gcode:
    {% if not printer["gcode_macro DRYER_CONFIG"].dryer_enabled %}
        M118 Dryer disabilitato, uscita da DRYER_REGENERATION_STEP_1
        RETURN
    {% endif %}
    {% set current_temp = printer["heater_generic DRYER_HEATER"].target %}
    SET_GCODE_VARIABLE MACRO=DRYER_CONFIG VARIABLE=saved_temp VALUE={current_temp}
    SET_HEATER_TEMPERATURE HEATER=DRYER_HEATER TARGET=70
    SET_PIN PIN=DRYER_MOTOR_PIN VALUE=0
    M118 DRYER: Inizio rigenerazione - riscaldamento a 70°C
    UPDATE_DELAYED_GCODE  ID=call_regen_step2 DURATION=5

[gcode_macro DRYER_REGENERATION_STEP_2]
gcode:
    {% if not printer["gcode_macro DRYER_CONFIG"].dryer_enabled %}
        M118 Dryer disabilitato, uscita da DRYER_REGENERATION_STEP_2
        RETURN
    {% endif %}
    SET_PIN PIN=DRYER_DIR_PIN VALUE=1
    SET_PIN PIN=DRYER_MOTOR_PIN VALUE=1
    M118 DRYER: Flusso invertito, modalità rigenerazione attiva - 10min
    UPDATE_DELAYED_GCODE  ID=call_regen_step3 DURATION=600

[gcode_macro DRYER_REGENERATION_STEP_3]
gcode:
    {% if not printer["gcode_macro DRYER_CONFIG"].dryer_enabled %}
        M118 Dryer disabilitato, uscita da DRYER_REGENERATION_STEP_3
        RETURN
    {% endif %}
    {% set saved = printer["gcode_macro DRYER_CONFIG"].saved_temp %}
    SET_HEATER_TEMPERATURE HEATER=DRYER_HEATER TARGET={saved}
    M118 DRYER: Temperatura ripristinata a S{saved}°C - riprendo asciugatura
    DRYER_DRYNG_STEP_1

[delayed_gcode call_drying_step2]
gcode:
    DRYER_DRYNG_STEP_2

[delayed_gcode call_regen_step1]
gcode:
    DRYER_REGENERATION_STEP_1

[delayed_gcode call_regen_step2]
gcode:
    DRYER_REGENERATION_STEP_2

[delayed_gcode call_regen_step3]
gcode:
    DRYER_REGENERATION_STEP_3

