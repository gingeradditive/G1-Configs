[mcu dryer_board]
serial: /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0

[output_pin _DRYER_MOTOR_PIN]
pin: dryer_board: PD2 #TODO: set correct pin

[output_pin _DRYER_DIR_PIN]
pin: dryer_board: PD3 #TODO: set correct pin

[heater_generic DRYER_HEATER]
heater_pin: dryer_board: PD5 #TODO: set correct pin
sensor_pin: dryer_board: PC1 #TODO: set correct pin
sensor_type: EPCOS 100K B57560G104F
control: pid
pid_Kp: 90
pid_Ki: 1.110
pid_Kd: 1287.354
min_temp: 0
max_temp: 110
pwm_cycle_time: 0.100
max_power: 1

[gcode_macro DRYER_CONFIG]
variable_dryer_enabled: False
variable_saved_temp: 0
gcode: 
    DRYER_DRYNG_STEP_1

[gcode_macro TOGGLE_DRYER]
description: Toggle Dryer ON/OFF with optional temperature
variable_TEMPERATURE: 60
gcode:
    {% set temp = params.TEMPERATURE|default(60)|float %}
    {% if printer["gcode_macro DRYER_CONFIG"].dryer_enabled %}
        SET_GCODE_VARIABLE MACRO=DRYER_CONFIG VARIABLE=dryer_enabled VALUE=False
        SET_HEATER_TEMPERATURE HEATER=DRYER_HEATER TARGET=0
        SET_PIN PIN=_DRYER_MOTOR_PIN VALUE=0
        SET_PIN PIN=_DRYER_DIR_PIN VALUE=0
        M118 Dryer disabled
    {% else %}
        SET_GCODE_VARIABLE MACRO=DRYER_CONFIG VARIABLE=dryer_enabled VALUE=True
        M118 Dryer enabled at {temp}C
        SET_HEATER_TEMPERATURE HEATER=DRYER_HEATER TARGET={temp}
        DRYER_DRYNG_STEP_1
    {% endif %}


[gcode_macro DRYER_DRYNG_STEP_1]
gcode:
    {% if printer["gcode_macro DRYER_CONFIG"].dryer_enabled %}
        SET_PIN PIN=_DRYER_MOTOR_PIN VALUE=0
        UPDATE_DELAYED_GCODE  ID=call_drying_step2 DURATION=5
    {% endif %}

[gcode_macro DRYER_DRYNG_STEP_2]
gcode:
    {% if printer["gcode_macro DRYER_CONFIG"].dryer_enabled %}
        SET_PIN PIN=_DRYER_DIR_PIN VALUE=0
        SET_PIN PIN=_DRYER_MOTOR_PIN VALUE=1
        M118 DRYER: drying in progress...
        UPDATE_DELAYED_GCODE  ID=call_regen_step1 DURATION=600
    {% endif %}


[gcode_macro DRYER_REGENERATION_STEP_1]
gcode:
    {% if printer["gcode_macro DRYER_CONFIG"].dryer_enabled %}
        {% set current_temp = printer["heater_generic DRYER_HEATER"].target %}
        SET_GCODE_VARIABLE MACRO=DRYER_CONFIG VARIABLE=saved_temp VALUE={current_temp}
        SET_HEATER_TEMPERATURE HEATER=DRYER_HEATER TARGET=70
        SET_PIN PIN=_DRYER_MOTOR_PIN VALUE=0
        M118 DRYER: Regeneration in progress...
        UPDATE_DELAYED_GCODE  ID=call_regen_step2 DURATION=5
    {% endif %}

[gcode_macro DRYER_REGENERATION_STEP_2]
gcode:
    {% if printer["gcode_macro DRYER_CONFIG"].dryer_enabled %}
        SET_PIN PIN=_DRYER_DIR_PIN VALUE=1
        SET_PIN PIN=_DRYER_MOTOR_PIN VALUE=1
        UPDATE_DELAYED_GCODE  ID=call_regen_step3 DURATION=600
    {% endif %}

[gcode_macro DRYER_REGENERATION_STEP_3]
gcode:
    {% if printer["gcode_macro DRYER_CONFIG"].dryer_enabled %}
        {% set saved = printer["gcode_macro DRYER_CONFIG"].saved_temp %}
        SET_HEATER_TEMPERATURE HEATER=DRYER_HEATER TARGET={saved}
        DRYER_DRYNG_STEP_1
    {% endif %}

[delayed_gcode call_drying_step2]
gcode:
    DRYER_DRYNG_STEP_2

[delayed_gcode call_regen_step1]
gcode:
    DRYER_REGENERATION_STEP_1

[delayed_gcode call_regen_step2]
gcode:
    DRYER_REGENERATION_STEP_2

[delayed_gcode call_regen_step3]
gcode:
    DRYER_REGENERATION_STEP_3

